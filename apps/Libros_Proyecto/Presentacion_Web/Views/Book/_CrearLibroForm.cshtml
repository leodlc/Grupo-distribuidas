@model Data.LIBRO

@using (Html.BeginForm(Model.IDLIBRO == 0 ? "Create" : "Edit", "Book", FormMethod.Post, new { id = "libroForm" }))
{
    @Html.AntiForgeryToken()
    <div class="form-horizontal">
        <h4>Libro</h4>
        <hr />
        @Html.ValidationSummary(true, "", new { @class = "text-danger" })

        <input type="hidden" id="IDLIBRO" name="IDLIBRO" value="@Model.IDLIBRO" />

        <div class="form-group">
            <label class="control-label col-md-2" for="NOMBRELIBRO">Nombre</label>
            <div class="col-md-10">
                <input type="text" class="form-control" id="NOMBRELIBRO" name="NOMBRELIBRO" value="@Model.NOMBRELIBRO" required maxlength="100" />
            </div>
        </div>
        <div class="form-group">
            <label class="control-label col-md-2" for="ANIOPUBLIBRO">Año de Publicación</label>
            <div class="col-md-10">
                <!-- Mostramos solo el año en el input -->
                <input type="text" class="form-control" id="ANIOPUBLIBRO" name="ANIOPUBLIBRO" maxlength="4"
                       value="@(Model.ANIOPUBLIBRO.HasValue ? Model.ANIOPUBLIBRO.Value.Year.ToString() : "")"
                       data-val="true" data-val-required="El año de publicación es obligatorio" />
            </div>
        </div>

        <div class="form-group">
            <label class="control-label col-md-2" for="IMGLIBRO">Portada del Libro</label>
            <div class="col-md-10">
                <input type="text" class="form-control" id="IMGLIBRO" name="IMGLIBRO" value="@Model.IMGLIBRO" />
            </div>
        </div>

        <div class="form-group">
            <label class="control-label col-md-2" for="ISBNLIBRO">ISBN</label>
            <div class="col-md-10">
                <input type="text" class="form-control" id="ISBNLIBRO" name="ISBNLIBRO" value="@Model.ISBNLIBRO" required maxlength="13" />
            </div>
        </div>

        <!-- Campo oculto para el estado del libro -->
        <input type="hidden" id="ESTADOLIBRO" name="ESTADOLIBRO" value="true" />

        <div class="form-group">
            <label class="control-label col-md-2" for="EDITORIALLIBRO">Editorial</label>
            <div class="col-md-10">
                <input type="text" class="form-control" id="EDITORIALLIBRO" name="EDITORIALLIBRO" value="@Model.EDITORIALLIBRO" required maxlength="100" />
            </div>
        </div>

        <div class="form-group">
            <label class="control-label col-md-2" for="STOCKLIBRO">Stock</label>
            <div class="col-md-10">
                <input type="number" class="form-control" id="STOCKLIBRO" name="STOCKLIBRO" value="@Model.STOCKLIBRO" />
            </div>
        </div>

        <div class="form-group">
            <label class="control-label col-md-2" for="IDGENERO">Género Literario</label>
            <div class="col-md-10">
                <select class="form-control" id="IDGL" name="IDGL" required>
                    <option value="">Seleccione un género...</option>
                    <!-- Opciones de géneros se cargarán dinámicamente -->
                </select>
            </div>
        </div>

        <div class="form-group">
            <label class="control-label col-md-2" for="IDAUTOR">Autor</label>
            <div class="col-md-10">
                <select class="form-control" id="IDAUTOR" name="IDAUTOR" required>
                    <option value="">Seleccione un autor...</option>
                    <!-- Opciones de autores se cargarán dinámicamente -->
                </select>
            </div>
        </div>

        <div class="form-group">
            <div class="col-md-offset-2 col-md-10">
                <div class="text-center">
                    <input type="submit" value="Guardar" class="btn btn-success" />
                </div>
            </div>
        </div>
    </div>
}

<!-- Agrega jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    $(document).ready(function () {
        // Función para cargar los autores disponibles desde una URL
        function cargarAutoresDisponibles() {
            $.ajax({
                url: 'http://localhost:54845/api/Author/GetAll', // Cambia esta URL según sea necesario
                type: 'GET',
                dataType: 'json',
                success: function (data) {
                    var select = $('#IDAUTOR');
                    select.empty();
                    select.append($('<option>').text('Seleccione un autor...').attr('value', ''));
                    $.each(data, function (index, autor) {
                        var optionText = autor.NOMBREAUTOR + " " + autor.APELLIDOAUTOR;
                        select.append($('<option>').text(optionText).attr('value', autor.IDAUTOR));
                    });

                    // Seleccionar el autor actual
                    select.val('@Model.IDAUTOR');
                },
                error: function () {
                    console.error("Error al cargar los autores disponibles.");
                }
            });
        }

        // Función para cargar los géneros disponibles desde una URL
        function cargarGenerosDisponibles() {
            $.ajax({
                url: 'http://localhost:54845/api/LiteraryGenre/GetAll', // Cambia esta URL según sea necesario
                type: 'GET',
                dataType: 'json',
                success: function (data) {
                    var select = $('#IDGL');
                    select.empty();
                    select.append($('<option>').text('Seleccione un género...').attr('value', ''));
                    $.each(data, function (index, genero) {
                        select.append($('<option>').text(genero.NOMBREGL).attr('value', genero.IDGL));
                    });

                    // Seleccionar el género actual
                    select.val('@Model.IDGL');
                },
                error: function () {
                    console.error("Error al cargar los géneros disponibles.");
                }
            });
        }

        // Llamar a las funciones para cargar los autores y géneros al cargar el documento
        cargarAutoresDisponibles();
        cargarGenerosDisponibles();

        $('#libroForm').on('submit', function (event) {
            var year = $('#ANIOPUBLIBRO').val();
            if (year.length === 4) {
                var date = new Date(year);
                var isoString = date.toISOString();
                console.log(isoString); // Esto mostrará "2024-01-01T00:00:00.000Z"
                $('#ANIOPUBLIBRO').val(isoString);
            } else {
                event.preventDefault();
                alert('Por favor, ingrese un año válido.');
            }
        });
    });
</script>
